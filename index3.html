<!DOCTYPE html>
<html>
	<head lang="en">
   		<meta charset="utf-8">
   		<title>A node.js WebRtc example</title>
		<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.0.11.js"></script>
	</head>
	<body>
		<h1 align="center">A node.js WebRtc example</h1>
		<form id="testWebRtc">
			msgToPeer: <input type="text" name="msg"><br><br>
			<input type="button" onclick="send()" value="send message">
		</form>
		<script>
		// PubNub object is the object responsible for communicating with the signaling . It uses a Pub/Sub model for communicating messages.
			var pubnub = new PubNub({
						publishKey : 'pub-c-4c1c39f8-813b-4424-9d41-c83b634cad79',
						subscribeKey : 'sub-c-67dc1f0e-829c-11e6-a8c4-0619f8945a4f'
					});
					
			var ICE_config= {
				'iceServers': [
						{'url': 'stun:stun.l.google.com:19302'},
						{'url': 'stun:stun1.l.google.com:19302'},
						{'url': 'stun:stun2.l.google.com:19302'},
						{'url': 'stun:stun3.l.google.com:19302'},
						{'url': 'stun:stun4.l.google.com:19302'}
						]};
			// WebRTC RTCPeerConnection object in chrome is called webkitRTCPeerConnection. It is used to establish video, audio and data streams.
			var peerCon1 = new webkitRTCPeerConnection(ICE_config);
			var channel;
			peerCon1.ondatachannel = function (e) {
				channel = e.channel
				e.channel.onmessage = function (e) {
					console.log("Got message from PEER:", e.data);
				}
			};
			// callback functions are added to handle three types of events. 
			pubnub.addListener({
				status: function(statusEvent) {
					// handle connection status
					console.log("status message received w/ status", statusEvent);
				},
				message: function(message) {
				// handle messages between subscribers
					var parsedMsgStep1 = JSON.parse(message.message);
					var username = parsedMsgStep1.username;
					if (username == "michael"){
						if(parsedMsgStep1.msgType == "offer" || parsedMsgStep1.msgType == "answer") {
							console.log("offerWasReceived:",	parsedMsgStep1);
							
							// FOR TESTING PURPOSES. NOT ACTUAL CODE.
							peerCon1.onicecandidate = function(e) 
							{
								console.log("iceCandidates",e);
							};
							offer = new SessionDescription(JSON.parse(parsedMsgStep1.offer))
							peerCon1.setRemoteDescription(offer);

							peerCon1.createAnswer(function (answer) {
								peerCon1.setLocalDescription(answer, function() {
									console.log("sucessfully created answer",peerCon1.localDescription);
									// NOW lets send the answer to anyone who is listening
									var publishConfig = 
									{
										channel : "test_channel1",
										message : 	JSON.stringify(
													{
														username: "himanish",
														msgType: "answer",
														offer: JSON.stringify(peerCon1.localDescription)
													})
									}
									pubnub.publish(publishConfig, function(status, response) 
									{
										//console.log("Just published a sdp offer message",status, response);
									})
								}, 
								function (err) 
								{
									console.log(err);
								});
							}, 
							function (err) 
							{
									console.log(err);
							});
						} else {
							addIceCandidate(JSON.parse(parsedMsgStep1.offer), function() 
							{
								console.log("adding ICE was successful")
							}, 
							function (err)
							{
							console.log("could not create offer, error:",err);
							}); 
							console.log("IceCandidateWasReceived:", parsedMsgStep1);

						}
					} else {
						console.log("myAnswerWasReceived:",	parsedMsgStep1);
					}

					//alert(message.message);
					
				},		
				presence: function(presenceEvent) {
					// handle presence
				}
			});
			
			// subscribe to already existing test_channel1 created using commented code in createChannel. 
			pubnub.subscribe({
					channels: ['test_channel1'],
					withPresence: true
				});
			
			// lists the channels currently configured for no_channel_group.
			function listAvailableChannels() {
				
				pubnub.channelGroups.listChannels(
					{
						channelGroup: "no_channel_group"
					}, 
					function (status, response) {
						if (status.error) {
							console.log("operation failed w/ error:", status);
							return;
						}
						 
						console.log("listing push channels for this device")
						response.channels.forEach( function (channel) {
							console.log(channel)
						});
					}
				);
			}
			
			// creates a text message and sends it to other subscribers on an already existing channel using the pubnub signaling server. FOR TESTING PURPOSES. NOT ACTUAL CODE. 
			function publishSampleMessage() {
				var publishConfig = {
					channel : "test_channel1",
					message : "Michael says: Hello from a pubnub server test!"
				}
				pubnub.publish(publishConfig, function(status, response) {
					//console.log("Just published a text message",status, response);
				})
			}
			//Create channel and place it inside a channel group. FOR TESTING PURPOSES. NOT ACTUAL CODE.
			function createChannel() {				
				// code no longer needed since channel is already established.
				//pubnub.channelGroups.addChannels(
				//	{
				//		channels: ['test_channel1'],
				//		channelGroup: "no_channel_group"
				//	}, 
				//	function(status) {
				//		if (status.error) {
				//			console.log("adding test_channel1 operation failed w/ status: ", status);
				//		} else {
				//			console.log("adding test_channel1 operation done!")
				//		}
				//	}
				//);
				
			}
			//Function that uses webRtc to create an offer sdp using STUN servers only for the ICE framework.
			
			function send(){
				var form = document.getElementById("testWebRtc");
				channel.send(form.msg.value);
			}
			
		</script>
	</body>
</html>