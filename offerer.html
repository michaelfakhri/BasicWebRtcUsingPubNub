<!DOCTYPE html>
<html>
	<head lang="en">
   		<meta charset="utf-8">
   		<title>A node.js WebRtc example</title>
		<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.0.11.js"></script>
		<script src="errorHandler.js"></script>
		<script src="debugger.js"></script>
		<script src="PubNubSignalingService.js"></script>
		<script src="peerConnection.js"></script>
	</head>
	<body>
		<h1 align="center">A node.js WebRtc example</h1>
		<input type="button" onclick="establishPeerTopeerConnection()" value="establish peer connection">
		<form id="testWebRtc">
			msgToPeer: <input type="text" name="msg"><br><br>
			<input type="button" onclick="send()" value="send message">
		</form>
		<script>
			signalingService = new PubNubSignalingService("michael");
			peerCon = new peerConnection("michael","himanish");

			signalingService.pubnub.addListener({
				status: function(statusEvent) {
					debug("status message received w/ status", statusEvent);
				},
				message: function(message) {
					var parsedMsg = JSON.parse(message.message);
					if (parsedMsg.origin == peerCon.clientId){
						debug("My "+parsedMsg.msgType+" was received:",	parsedMsg);
					} else if(parsedMsg.destination == peerCon.clientId){
						debug(parsedMsg.msgType+" was received:",	parsedMsg);
						if(parsedMsg.msgType == "offer") {
							peerCon.RTCpeerConnection.setRemoteDescription(parsedMsg.msg);
							peerCon.RTCpeerConnection.createAnswer(
								function (answer) 
								{
									peerCon.RTCpeerConnection.setLocalDescription(answer,
										function(){
											debug("sucessfully created answer",peerCon.RTCpeerConnection.localDescription);
											signalingService.generateAndSendMessage(peerCon.clientId, peerCon.targetId, "answer", peerCon.RTCpeerConnection.localDescription);
										},
										generateErrorHandler("WebRtc sdp answer setting as local descriptor failed w/ error:")
									);
								}, 
								generateErrorHandler("WebRtc sdp answer creation failed w/ error:"));
						}else if(parsedMsg.msgType == "answer"){
							peerCon.RTCpeerConnection.setRemoteDescription(parsedMsg.msg);
						} else if(parsedMsg.msgType == "ICE candidate"){
							peerCon.RTCpeerConnection.addIceCandidate(parsedMsg.msg,
								generateDebugger("adding ICE was successful"), 
								generateErrorHandler("Adding ICE candidate Failed w/ error:")); 
						}
					}	
				},		
				presence: function(presenceEvent) {
					debug("presence message received w/ status", presenceEvent);
				}
			});
			

			function establishPeerTopeerConnection() {
			
				peerCon.channel = peerCon.RTCpeerConnection.createDataChannel("dataChannel", {});
				configureChannel(peerCon.channel);
				
				peerCon.RTCpeerConnection.createOffer(
					function (offer) 
					{
						peerCon.RTCpeerConnection.setLocalDescription(offer, 
							function() 
							{
								signalingService.generateAndSendMessage(peerCon.clientId, peerCon.targetId, "offer", peerCon.RTCpeerConnection.localDescription);
								debug("sucessfully created and sent offer",peerCon.RTCpeerConnection.localDescription);
							} 
						) 
					},
					generateErrorHandler("WebRtc sdp Offer creation failed w/ error:")
				);
			} 
			
			function send(){
				var form = document.getElementById("testWebRtc");
				peerCon.channel.send(form.msg.value);
			}
			
		</script>
	</body>
</html>